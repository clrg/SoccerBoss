/*

Software License Agreement (BSD License)
http://taffydb.com
Copyright (c) 2008
All rights reserved.



Redistribution and use of this software in source and binary forms, with or without modification, are permitted provided that the following condition is met:

* Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


SUMMARY:
TAFFY takes a JavaScript object and returns a set of methods
to search, modify, and manipulate that object.





*/

TAFFY=function(obj){var raw=obj;var TAFFYObj=obj;function typeOf(value){var s=typeof value;if(s==='object'){if(value){if(typeof value.length==='number'&&!(value.propertyIsEnumerable('length'))&&typeof value.splice==='function'){s='array';}}else{s='null';}}return s;}var isArray=function(thing){if(typeOf(thing)=='array'){return true;}else{return false;}};var isObject=function(thing){if(typeOf(thing)=='object'){return true;}else{return false;}};var isString=function(thing){if(typeOf(thing)=='string'){return true;}else{return false;}};var isNumber=function(thing){if(typeOf(thing)=='number'){return true;}else{return false;}};var findTests={regexppass:function(mvalue,mtest){return(mtest.test(mvalue))?true:false;},regexpfail:function(mvalue,mtest){return(!mtest.test(mvalue))?true:false;},lessthan:function(mvalue,mtest){return(mvalue<mtest)?true:false;},greaterthan:function(mvalue,mtest){return(mvalue>mtest)?true:false;},startswith:function(mvalue,mtest){return(mvalue.indexOf(mtest)===0)?true:false;},endswith:function(mvalue,mtest){var start=mvalue.length-mtest.length;return(mvalue.substring(start)==mtest)?true:false;},like:function(mvalue,mtest){return(mvalue.indexOf(mtest)>=0)?true:false;},notlike:function(mvalue,mtest){return(mvalue.indexOf(mtest)===-1)?true:false;},equal:function(mvalue,mtest){return(mvalue==mtest)?true:false;},notequal:function(mvalue,mtest){return(mvalue!=mtest)?true:false;},arraycontains:function(mvalue,mtest){if(isArray(mvalue)){for(var TAFa=0;TAFa<mvalue.length;TAFa++){if(mvalue[TAFa]==mtest){return true;}}}else{if(mvalue==mtest){return true;}}return false;}};var makeIndexArray=function(indexArray,finderFunc){var returnArray=[];if(isArray(indexArray)==0&isString(indexArray)){returnArray[returnArray.length]=indexArray;}else if(isArray(indexArray)==1){returnArray=indexArray;}else if(isObject(indexArray)){returnArray=finderFunc(indexArray);}else if(isArray(indexArray)==0&isString(indexArray)==0){for(var miAd=0;miAd<TAFFYObj.length;miAd++){returnArray[returnArray.length]=miAd;}}return returnArray;};var buildSortFunction=function(sortobj){var customSortObj=[];var localSortObj=[];if(isString(sortobj)){localSortObj[0]=sortobj;}else{localSortObj=sortobj;}if(isArray(localSortObj)){for(var sa=0;sa<localSortObj.length;sa++){if(isString(localSortObj[sa])){if(isString(TAFFYObj[0][localSortObj[sa]])){customSortObj[customSortObj.length]={sortCol:localSortObj[sa],sortDir:"desc",type:"string"};}else{customSortObj[customSortObj.length]={sortCol:localSortObj[sa],sortDir:"desc",type:"number"};}}else if(isObject(localSortObj[sa])){for(var sc in localSortObj[sa]){if(isString(TAFFYObj[0][localSortObj[sa].sortCol])){customSortObj[customSortObj.length]={sortCol:sc,sortDir:localSortObj[sa][sc],type:"string"};}else{customSortObj[customSortObj.length]={sortCol:sc,sortDir:localSortObj[sa][sc],type:"number"};}}}}}return function(a,b){var returnvar=0;var r1=a;var r2=b;var x;var y;for(var sa=0;sa<customSortObj.length;sa++){if(returnvar===0){x=r1[customSortObj[sa]["sortCol"]];y=r2[customSortObj[sa]["sortCol"]];if(customSortObj[sa].type=='string'){x=x.toLowerCase();y=y.toLowerCase();}if(customSortObj[sa].sortDir=='desc'){if(x<y){returnvar=-1;}else if(x>y){returnvar=1;}}else{if(x>y){returnvar=-1;}else if(x<y){returnvar=1;}}}}return returnvar;};};return{raw:raw,length:TAFFYObj.length,lastModifyDate:new Date(),find:function(matchObj,findFilter){var findMatches=[];var findMatchesLoaded=0;var findIndex=0;for(var mi in matchObj){var matchType='equal';var matchValue='';var matchField=mi;if(isObject(matchObj[mi])){for(var fi in matchObj[mi]){switch(fi){case'equal':case'is':matchType='equal';break;case'notequal':case'not':matchType='notequal';break;case'startswith':case'starts':matchType='startswith';break;case'endswith':case'ends':matchType='endswith';break;case'greaterthan':case'gt':matchType='greaterthan';break;case'lessthan':case'lt':matchType='lessthan';break;case'regexppass':case'regex':matchType='regexppass';break;case'regexpfail':matchType='regexpfail';break;case'arraycontains':case'contains':matchType='arraycontains';break;case'like':case'notlike':matchType=fi;break;default:matchType='equal';break;}matchValue=matchObj[mi][fi];}}else{matchValue=matchObj[mi];}if(findMatchesLoaded==0){if(isArray(findFilter)){findMatches=findFilter;}else{for(var fd=0;fd<TAFFYObj.length;fd++){findMatches[findMatches.length]=fd;}}findMatchesLoaded=1;}var thisMatchArray=[];for(var d=0;d<findMatches.length;d++){if(isArray(matchValue)){for(var md=0;md<matchValue.length;md++){if(findTests[matchType](TAFFYObj[findMatches[d]][matchField],matchValue[md])){thisMatchArray[thisMatchArray.length]=findMatches[d];}}}else if(findTests[matchType](TAFFYObj[findMatches[d]][matchField],matchValue)){thisMatchArray[thisMatchArray.length]=findMatches[d];}}findMatches=thisMatchArray;}return findMatches;},remove:function(removeIndex){var removeIndex=makeIndexArray(removeIndex,this.find);if(this.onRemove!=null){for(var d=0;d<removeIndex.length;d++){this.onRemove(TAFFYObj[removeIndex[d]]);}}for(var di=0;di<removeIndex.length;di++){TAFFYObj[removeIndex[di]]='remove';}var removeRemaining=function(){for(var tdi=0;tdi<TAFFYObj.length;tdi++){if(TAFFYObj[tdi]==='remove'){return true;}}return false;};while(removeRemaining()){for(var tdi=0;tdi<TAFFYObj.length;tdi++){if(TAFFYObj[tdi]==='remove'){TAFFYObj.splice(tdi,1);this.lastModifyDate=new Date();}}}this.length=TAFFYObj.length;return removeIndex;},insert:function(newRecordObj){if(this.onInsert!=null){this.onInsert(newRecordObj);}TAFFYObj[TAFFYObj.length]=newRecordObj;this.lastModifyDate=new Date();this.length=TAFFYObj.length;return[TAFFYObj.length-1];},update:function(updateObj,updateIndex){var updateIndex=makeIndexArray(updateIndex,this.find);if(this.onUpdate!=null){for(var d=0;d<updateIndex.length;d++){this.onUpdate(updateObj,TAFFYObj[updateIndex[d]]);}}for(var ui in updateObj){var updateDex=0;var updateCount=0;for(var d=0;d<updateIndex.length;d++){updateDex=updateIndex[d];if(ui.length>0){TAFFYObj[updateDex][ui]=updateObj[ui];this.lastModifyDate=new Date();}}updateCount++;}this.length=TAFFYObj.length;return updateIndex;},get:function(getIndex){var newTAFFYArray=[];var getIndex=makeIndexArray(getIndex,this.find);for(var d=0;d<getIndex.length;d++){newTAFFYArray[newTAFFYArray.length]=TAFFYObj[getIndex[d]];}return newTAFFYArray;},first:function(getIndex){var newTAFFYRow=false;var getIndex=makeIndexArray(getIndex,this.find);for(var d=0;d<getIndex.length;d++){newTAFFYRow=TAFFYObj[getIndex[d]];break;}return newTAFFYRow;},orderBy:function(orderByObj){if(this.length>0){var customSort=buildSortFunction(orderByObj);TAFFYObj.sort(customSort);this.lastModifyDate=new Date();}},forEach:function(func2call,forIndex){var forIndex=makeIndexArray(forIndex,this.find);var row;for(var fe=0;fe<forIndex.length;fe++){row=TAFFYObj[forIndex[fe]];var nr=func2call(row);if(isObject(nr)){TAFFYObj[forIndex[fe]]=nr;}}},onUpdate:null,onRemove:null,onInsert:null};};